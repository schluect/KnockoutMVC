!function(t,o){"function"==typeof define&&define.amd?define(["jquery","knockout","sammy"],o):t.komvc=o(t.$,t.ko,t.sammy)}(this,function(t,o,e){var n=n||{};return n.ko=o,n.Sammy=Sammy,n.$=jQuery,n.JSON=JSON,n.config={ViewsLocation:"/app",AppSelector:null,UseRequire:!1,CustomRoutes:null,SammyVerbs:["get","post","put","delete"],DefaultRoutes:["#/","#/:controller","#/:controller/:action"]},n.utils=function(t){return{extend:function(t,o){var e=o.prototype;o.prototype=Object.create(t.prototype);for(var n in e)o.prototype[n]=e[n];o.prototype.constructor=o,Object.defineProperty(o.prototype,"constructor",{enumerable:!1,value:o})},createTemplate:function(o,e){if(0===t("#"+o).length){var n=t("<script>");n.attr("id",o),n.attr("type","script/html"),n.html(e),t("body").append(n)}},loadTemplate:function(o,e,n){0===t("#"+o).length?t.ajax(e,function(e){var r=t("<script>");r.attr("id",o),r.attr("type","script/html"),r.html(e),t("body").append(r),n()}):n()},forEach:function(t,o){for(var e in t)if(t.hasOwnProperty(e)){var n=t[e];o(e,n)}}}}(n.$),n.ApplicationViewModelHolder=function(t){var o=null,e=function(){};return e.prototype.View=t.observable(null),e.prototype.Model=t.observable(null),function(){return o=o||new e}}(n.ko),n.Controller=function(){var t=function(){};return t.prototype.Get=function(t,o){var e=null,r=null;"string"==typeof t?(e=t.toString(),r=o):"object"==typeof t&&(r=t.model,e=t.view);var i=new n.ActionResult(this.Name,e,r);i.Process()},t.prototype.Post=function(){},t.prototype.Put=function(){},t.prototype.Delete=function(){},t.prototype.Name="",t.prototype.addAction=function(t,o){this[t]=o},t}(),n.ControllerFactory=function(){var t=function(){};return t.prototype.Controllers={},t.prototype.AddController=function(t,o){if("undefined"==typeof o)throw"controller is required";t=t.toLowerCase(),this.Controllers[t]=o},t.prototype.CreateController=function(t,o){if("undefined"==typeof t)throw"name is required";"undefined"==typeof o&&(o={index:function(){this.Get(e.name+"_index")}});var e=new n.Controller;e.Name=t,n.utils.forEach(o,function(t,o){e.addAction(t,o)});var r=(t+"controller").toLowerCase();this.Controllers[r]=e},t.prototype.GetController=function(t){return t=t.toLowerCase(),"undefined"!=typeof this.Controllers[t]?this.Controllers[t]:null},t}(),n.RouteChangeHandler=function(o){var e=[],r=function(t){var o=this;this.RouteHandler=t,e=[["get","#/:controller/:action",function(t){o.HandleActionResult(o.RouteHandler.RunAction(t.controller,t.action,t.params))}],["get","#/:controller",function(t){o.HandleActionResult(o.RouteHandler.RunAction(t.controller,"index",t.params))}],["get","#/",function(t){o.HandleActionResult(o.RouteHandler.RunAction("home","index",t.params))}]]};return r.prototype._SammyApp=null,r.prototype.RouteHandler=null,r.prototype.HandleActionResult=function(t){t.NotFound&&context.notFound(),t.Error&&context.error(t.Error)},r.prototype.StartRouteChangeHandler=function(n){var r=e;if("undefined"!=typeof n&&Array.isArray(n)){var i=t.map(n,function(t){return this.ValidateCustomRoute(t)?t:void 0});t.merge(r,i)}var l=o("#main",function(){this.mapRoutes(r)});return l.run("#/"),this._SammyApp=l,this._SammyApp},r.prototype.GetSammyApp=function(){return this._SammyApp},r.prototype.ValidateCustomRoute=function(t){if(Array.isArray(t)){var o=t.length;if(2===o)return this.ValidateCustomRouteWithoutVerb(t);if(3===o)return this.ValidateCustomRouteWithoutVerb(t)}return!1},r.prototype.ValidateCustomRouteWithVerb=function(t,o,e){return"string"==typeof t&&-1!==n.config.SammyVerbs.indexOf(t)?this.ValidateCustomRouteWithoutVerb(o,e):!1},r.prototype.ValidateCustomRouteWithoutVerb=function(t,o){return"string"==typeof t&&"function"==typeof o&&-1==n.config.DefaultRoutes.indexOf(t)},r}(n.Sammy),n.Run=function(t){var e=null,r=null,i=null,l="[data-komvc=true]",u=function(o){if(t.extend(n.config,o),n.config.AppContainer=t(n.config.AppSelector),0==n.config.AppContainer.length&&(t("body").attr("data-komvc",!0),n.config.AppSelector=l,n.config.AppContainer=t(n.config.AppSelector)),1!==n.config.AppContainer.length)throw"Only one App Container allowed";n.config.UseRequire?a(o.Controllers,p):p(o)},a=function(t,o,e){"undefined"!=typeof t&&Array.isArray(t)&&require(t,function(){o.Controllers=arguments,e(o)})},p=function(l){e=new n.ControllerFactory,t.each(l.Controllers,function(t,o){e.CreateController(o.name,o.actions)}),r=new n.RouteHandler(e),i=new n.RouteChangeHandler(r),i.StartRouteChangeHandler(n.config.CustomRoutes),t(function(){n.config.AppContainer.attr('data-bind="template: { name: View, data: Model }"'),o.applyBindings(n.ApplicationViewModelHolder(),n.config.AppContainer[0])})};return n.config.AppSelector=l,u}(n.$),n.RouteHandler=function(){var t=function(t){this.ControllerFactory=t};return t.prototype.ControllerFactory=null,t.prototype.ActivateController=function(t){return this.ActiveController=this.ControllerFactory.GetController(t+"controller"),"undefined"==typeof this.ActiveController?null:void 0},t.prototype.RunAction=function(t,o,e){try{var n=this.ControllerFactory.GetController(t+"controller");if("undefined"==typeof n)return{NotFound:!0};if("undefined"==typeof n[o])return{NotFound:!0};n[o](e)}catch(r){return{Error:r}}},t}(),n.ActionResult=function(t){var o=function(t,o,e){this.ProcessView(o,t),this.Model=e};return o.prototype.ViewKey=null,o.prototype.View=null,o.prototype.Model=null,o.prototype.ViewPath=null,o.prototype.ProcessView=function(t,o){if(null!==t){var e=t.split("/");e.length>1?(this.ViewPath=t,this.View=e[e.length-1]):(this.View=t,this.ViewPath="/views/"+o+"/"+this.View),this.ViewPath.indexOf(".html")<0&&(this.ViewPath+=".html"),this.ViewPath=n.config.ViewsLocation+this.ViewPath,this.View=o+"_"+this.View}},o.prototype.Process=function(){n.utils.loadTemplate(this.View,this.ViewPath,function(){t().View(this.View),t().Model(this.Model)})},o}(n.ApplicationViewModelHolder),n});