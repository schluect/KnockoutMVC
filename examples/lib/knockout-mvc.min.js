!function(t,e){"function"==typeof define&&define.amd?define(["jquery","knockout","sammy"],e):t.komvc=e(t.$,t.ko,t.sammy)}(this,function(t,e,o){var n=n||{};n.ko=e,n.Sammy=Sammy,n.$=jQuery,n.JSON=JSON,n.config={ViewsLocation:"/app",AppSelector:null,UseRequire:!1,CustomRoutes:null,SammyVerbs:["get","post","put","delete"],DefaultRoutes:["#/","#/:controller","#/:controller/:action"],Resources:{}};var r,i,a;n.utils=function(t){return{extend:function(t,e){var o=e.prototype;e.prototype=Object.create(t.prototype);for(var n in o)e.prototype[n]=o[n];e.prototype.constructor=e,Object.defineProperty(e.prototype,"constructor",{enumerable:!1,value:e})},createTemplate:function(e,o){if(0===t("#"+e).length){var n=t("<script>");n.attr("id",e),n.attr("type","script/html"),n.html(o),t("body").append(n)}},loadTemplate:function(e,o,n){0===t("#"+e).length?t.ajax(o).then(function(o){var r=t("<script>");r.attr("id",e),r.attr("type","script/html"),r.html(o),t("body").append(r),n()}):n()},forEach:function(t,e){for(var o in t)if(t.hasOwnProperty(o)){var n=t[o];e(o,n)}}}}(n.$),n.InitializeResources=function(e){var o=[];return t.each(e,function(t,e){if("undefined"==typeof n.config.Resources[e])throw"Resource: "+e+" is missing.";var r=n.config.Resources[e];"function"==typeof r?o.push(new n.config.Resources[e]):o.push(r)}),o},n.RegisterService=function(t,e){n.config.Resources[t]=e},n.ApplicationViewModelHolder=function(t){var e=null,o=function(){};return o.prototype.ApplicationState=t.observable({View:null,Model:null}),o.prototype.UpdateApplicationState=function(t,e){"function"!=typeof e.afterRender&&(e.afterRender=function(){}),this.ApplicationState({View:t,Model:e})},function(){return e=e||new o}}(n.ko),n.Controller=function(){var t=function(){};return t.prototype.Get=function(t,e){var o=null,r=null;"string"==typeof t?(o=t.toString(),r=e):"object"==typeof t&&(r=t.model,o=t.view);var i=new n.ActionResult(this.Name,o,r);i.Process()},t.prototype.Post=function(){},t.prototype.Put=function(){},t.prototype.Delete=function(){},t.prototype.Name="",t.prototype.addAction=function(t,e){this[t.toLowerCase()]=e},t}(),n.ControllerFactory=function(){var t=function(){};return t.prototype.Controllers={},t.prototype.AddController=function(t,e){if("undefined"==typeof e)throw"controller is required";t=t.toLowerCase(),this.Controllers[t]=e},t.prototype.CreateController=function(t,e,o){if("undefined"==typeof t)throw"name is required";"undefined"==typeof e&&(e={index:function(){this.Get(r.name+"_index")}});var r=new n.Controller;r.Name=t.toLowerCase(),n.utils.forEach(e,function(t,e){r.addAction(t,e)});var i=this.CreateControllerTypeKey(t,o);this.Controllers[i]=r},t.prototype.GetController=function(t,e){var o=this.CreateControllerTypeKey(t,e);return"undefined"!=typeof this.Controllers[o]?this.Controllers[o]:null},t.prototype.CreateControllerTypeKey=function(t,e){return(t+"controller_"+e).toLowerCase()},t}(),n.RouteChangeHandler=function(e){var o=[],r=function(t){var e=this;this.RouteHandler=t,o=[["get","#/:controller/:action",function(t){e.HandleActionResult(e.RouteHandler.RunAction(t.params.controller,t.params.action,t.params,t))}],["get","#/:controller",function(t){e.HandleActionResult(e.RouteHandler.RunAction(t.params.controller,"index",t.params,t))}],["get","#/",function(t){e.HandleActionResult(e.RouteHandler.RunAction("home","index",t.params,t))}],["post","#/:controller/:action",function(t){e.HandleActionResult(e.RouteHandler.RunAction(t.params.controller,t.params.action,t.params,t))}],["post","#/:controller",function(t){e.HandleActionResult(e.RouteHandler.RunAction(t.params.controller,"index",t.params,t))}],["post","#/",function(t){e.HandleActionResult(e.RouteHandler.RunAction("home","index",t.params,t))}]]};return r.prototype._SammyApp=null,r.prototype.RouteHandler=null,r.prototype.HandleActionResult=function(t){"undefined"!=typeof t&&(t.NotFound&&this._SammyApp.notFound(),t.Error&&this._SammyApp.error(t.Error))},r.prototype.StartRouteChangeHandler=function(r){var i=o;if("undefined"!=typeof r&&Array.isArray(r)){var a=t.map(r,function(t){return this.ValidateCustomRoute(t)?t:void 0});t.merge(i,a)}var u=e(n.config.AppSelector,function(){this.mapRoutes(i),this.bind("run",function(e){var o=this;t("body").on("click","a",function(e){var n=t(e.target).attr("href");return 0===n.indexOf("#")?(e.preventDefault(),o.redirect(t(e.target).attr("href")),!1):void 0})})});return u.run("#/"),this._SammyApp=u,this._SammyApp},r.prototype.GetSammyApp=function(){return this._SammyApp},r.prototype.ValidateCustomRoute=function(t){if(Array.isArray(t)){var e=t.length;if(2===e)return this.ValidateCustomRouteWithoutVerb(t);if(3===e)return this.ValidateCustomRouteWithoutVerb(t)}return!1},r.prototype.ValidateCustomRouteWithVerb=function(t,e,o){return"string"==typeof t&&-1!==n.config.SammyVerbs.indexOf(t)?this.ValidateCustomRouteWithoutVerb(e,o):!1},r.prototype.ValidateCustomRouteWithoutVerb=function(t,e){return"string"==typeof t&&"function"==typeof e&&-1==n.config.DefaultRoutes.indexOf(t)},r}(n.Sammy),n.Run=function(t){var o="#komvccontainer",l=function(e){if(t.extend(n.config,e),n.config.AppContainer=t(n.config.AppSelector),0===n.config.AppContainer.length&&(t("body").attr("data-komvc",!0),n.config.AppSelector=o,n.config.AppContainer=t(n.config.AppSelector)),1!==n.config.AppContainer.length)throw"Only one App Container allowed";n.config.UseRequire?p(e.Controllers,f):f(e)},p=function(t,e,o){"undefined"!=typeof t&&Array.isArray(t)&&require(t,function(){e.Controllers=arguments,o(e)})},c=function(){if("object"==typeof u)for(var t in u){var e=u[t];for(var o in e){var n=e[o];r.CreateController(t,n,o)}}},f=function(o){r=new n.ControllerFactory,c(),i=new n.RouteHandler(r),a=new n.RouteChangeHandler(i),a.StartRouteChangeHandler(n.config.CustomRoutes),t(function(){n.config.AppContainer.append("<!-- ko with: ApplicationState --><!-- ko if: View !== null --><!-- ko template: { name: View, data: Model, afterRender: Model.afterRender } --><!-- /ko --><!-- /ko --><!-- /ko -->"),e.applyBindings(n.ApplicationViewModelHolder(),n.config.AppContainer[0])})};return n.config.AppSelector=o,l}(n.$),n.RouteHandler=function(){var t=function(t){this.ControllerFactory=t};return t.prototype.ControllerFactory=null,t.prototype.ActivateController=function(t){this.ActiveController=this.ControllerFactory.GetController(t),"undefined"==typeof this.ActiveController},t.prototype.RunAction=function(t,e,o,n){try{var r=this.ControllerFactory.GetController(t,n.verb);return"undefined"==typeof r?{NotFound:!0}:"undefined"==typeof r[e]?{NotFound:!0}:r[e](o,n)}catch(i){return{Error:i}}},t}(),n.ActionResult=function(t,e){var o=function(t,e,o){this.ProcessView(e,t),this.Model=o};return o.prototype.ViewKey=null,o.prototype.View=null,o.prototype.Model=null,o.prototype.ViewPath=null,o.prototype.ProcessView=function(t,e){if(null!==t){var o=t.split("/");o.length>1?(this.ViewPath=t,this.View=o[o.length-1]):(this.View=t,this.ViewPath="/views/"+e+"/"+this.View),this.ViewPath.indexOf(".html")<0&&(this.ViewPath+=".html"),this.ViewPath=n.config.ViewsLocation+this.ViewPath,this.View=e+"_"+this.View}},o.prototype.Process=function(){var e=this;n.utils.loadTemplate(this.View,this.ViewPath,function(){t().UpdateApplicationState(e.View,e.Model)})},o}(n.ApplicationViewModelHolder,n.$);var u={};return Controller=function(t,e,o){var r=[],i=this;"function"==typeof e?(o=e,e=null):r=n.InitializeResources(e),i.Action=function(e,o,n){if("function"==typeof o&&(n=o,o="get"),"undefined"==typeof u[t])u[t]={},u[t][o]={},u[t][o][e]=n;else{var r=u[t];"undefined"==typeof r[o]&&(r[o]={}),"undefined"==typeof r[o][e]&&(r[o][e]=n)}},o.apply(i,r)},n});